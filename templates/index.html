<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kleantype - AI Text Cleaner</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Mohave:wght@700&family=Libre+Baskerville:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="main-container sans-serif-font">
        <!-- Header -->
        <div class="header">
            <h1 class="title">Kleantype</h1>
            <div class="header-subtitle">Advanced AI text cleaner with drift-resistant multi-pass processing</div>
            <button id="font-toggle" class="font-toggle">Switch to Serif</button>
        </div>

        <!-- Main Content -->
        <div class="content-wrapper">
            <!-- Input Section -->
            <div class="input-section">
                <h2>Input Text</h2>
                <textarea 
                    id="input-text" 
                    placeholder="Paste your AI-generated text here. Kleantype will remove AI artifacts, fix formatting issues, and improve readability through intelligent multi-pass analysis..."
                    rows="12"></textarea>
                <button id="process-btn" class="process-btn">Clean Text</button>
            </div>

            <!-- Progress Section (hidden by default) -->
            <div id="progress-section" class="progress-section" style="display: none;">
                <h2>Processing Progress</h2>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div id="progress-fill" class="progress-fill"></div>
                    </div>
                    <div class="progress-text">
                        <span id="progress-percentage">0%</span>
                        <span id="progress-status">Initializing...</span>
                    </div>
                </div>
                
                <!-- Pass Indicators -->
                <div class="pass-indicators">
                    <div class="pass-indicator" data-pass="1">
                        <div class="pass-icon">üîç</div>
                        <div class="pass-info">
                            <div class="pass-title">Technical Analysis</div>
                            <div class="pass-description">Identifying AI artifacts and disclosure phrases</div>
                        </div>
                    </div>
                    <div class="pass-indicator" data-pass="2">
                        <div class="pass-icon">‚úèÔ∏è</div>
                        <div class="pass-info">
                            <div class="pass-title">Style Analysis</div>
                            <div class="pass-description">Detecting formatting and style issues</div>
                        </div>
                    </div>
                    <div class="pass-indicator" data-pass="3">
                        <div class="pass-icon">üìù</div>
                        <div class="pass-info">
                            <div class="pass-title">Language Analysis</div>
                            <div class="pass-description">Finding promotional and editorial language</div>
                        </div>
                    </div>
                    <div class="pass-indicator" data-pass="4">
                        <div class="pass-icon">üîÑ</div>
                        <div class="pass-info">
                            <div class="pass-title">Flow Analysis</div>
                            <div class="pass-description">Evaluating readability and transitions</div>
                        </div>
                    </div>
                    <div class="pass-indicator" data-pass="5">
                        <div class="pass-icon">‚ö°</div>
                        <div class="pass-info">
                            <div class="pass-title">Smart Consolidation</div>
                            <div class="pass-description">Applying all fixes with fresh AI instance</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Output Section -->
            <div class="output-section">
                <div class="output-header">
                    <h2>Cleaned Text</h2>
                    <button id="copy-btn" class="copy-btn" style="display: none;">Copy to Clipboard</button>
                </div>
                <div id="output-text" class="output-text"></div>
            </div>
        </div>

        <!-- Loading overlay -->
        <div id="loading" class="loading" style="display: none;">
            <div id="loading-text">Processing your text...</div>
            <div id="loading-status">Initializing analysis...</div>
        </div>
    </div>

    <script>
        let currentFont = 'sans-serif';
        
        // Font toggle functionality
        document.getElementById('font-toggle').addEventListener('click', function() {
            const mainContainer = document.querySelector('.main-container');
            const button = document.getElementById('font-toggle');
            
            if (currentFont === 'sans-serif') {
                mainContainer.classList.remove('sans-serif-font');
                mainContainer.classList.add('serif-font');
                button.textContent = 'Switch to Sans-Serif';
                currentFont = 'serif';
            } else {
                mainContainer.classList.remove('serif-font');
                mainContainer.classList.add('sans-serif-font');
                button.textContent = 'Switch to Serif';
                currentFont = 'sans-serif';
            }
        });

        // Process button functionality
        document.getElementById('process-btn').addEventListener('click', function() {
            const inputText = document.getElementById('input-text').value.trim();
            
            if (!inputText) {
                alert('Please enter some text to process.');
                return;
            }

            // Show progress section and hide copy button
            document.getElementById('progress-section').style.display = 'block';
            document.getElementById('copy-btn').style.display = 'none';
            
            // Reset all pass indicators
            const passIndicators = document.querySelectorAll('.pass-indicator');
            passIndicators.forEach(indicator => {
                indicator.classList.remove('active', 'completed');
            });
            
            // Reset output
            document.getElementById('output-text').innerHTML = '';
            
            // Reset progress
            updateProgress(0, 'Starting analysis...');

            // Make the API call
            fetch('/process', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ text: inputText })
            })
            .then(response => {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let outputBuffer = '';

                function readChunk() {
                    return reader.read().then(({ done, value }) => {
                        if (done) {
                            document.getElementById('copy-btn').style.display = 'inline-block';
                            return;
                        }

                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');

                        lines.forEach(line => {
                            if (line.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(line.slice(6));
                                    
                                    if (data.error) {
                                        console.error('Error:', data.error);
                                        updateProgress(100, 'Error occurred');
                                        return;
                                    }
                                    
                                    if (data.pass && data.status) {
                                        handlePassStatus(data.pass, data.status);
                                    }
                                    
                                    if (data.pass && data.content) {
                                        if (data.pass === 5) {
                                            // Consolidation pass - stream the actual output
                                            outputBuffer += data.content;
                                            document.getElementById('output-text').innerHTML = formatOutput(outputBuffer);
                                        }
                                        // For analysis passes (1-4), just show completion checkmark
                                    }
                                    
                                    if (data.done) {
                                        updateProgress(100, 'Complete!');
                                        document.getElementById('copy-btn').style.display = 'inline-block';
                                    }
                                    
                                } catch (e) {
                                    console.error('Parse error:', e);
                                }
                            }
                        });

                        return readChunk();
                    });
                }

                return readChunk();
            })
            .catch(error => {
                console.error('Error:', error);
                updateProgress(100, 'Error occurred');
            });
        });

        function handlePassStatus(passNumber, status) {
            const passIndicator = document.querySelector(`[data-pass="${passNumber}"]`);
            
            if (status === 'analyzing') {
                // Mark pass as active
                passIndicator.classList.add('active');
                updateProgress((passNumber - 1) * 20, `Analyzing (Pass ${passNumber}/5)...`);
            } else if (status === 'consolidating') {
                // Mark consolidation as active
                passIndicator.classList.add('active');
                updateProgress(80, 'Consolidating with fresh AI instance...');
            } else if (status === 'completed') {
                // Mark pass as completed
                passIndicator.classList.remove('active');
                passIndicator.classList.add('completed');
                
                if (passNumber < 5) {
                    updateProgress(passNumber * 16, `Analysis ${passNumber}/4 complete`);
                } else {
                    updateProgress(100, 'Processing complete!');
                }
            }
        }

        function updateProgress(percentage, status) {
            document.getElementById('progress-fill').style.width = percentage + '%';
            document.getElementById('progress-percentage').textContent = Math.round(percentage) + '%';
            document.getElementById('progress-status').textContent = status;
        }

        function formatOutput(text) {
            // Preserve line breaks and basic formatting
            return text.replace(/\n/g, '<br>');
        }

        // Copy to clipboard functionality
        document.getElementById('copy-btn').addEventListener('click', function() {
            const outputText = document.getElementById('output-text').innerText;
            
            navigator.clipboard.writeText(outputText).then(function() {
                const button = document.getElementById('copy-btn');
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                button.style.backgroundColor = '#27AE60';
                
                setTimeout(function() {
                    button.textContent = originalText;
                    button.style.backgroundColor = '';
                }, 2000);
            }).catch(function(err) {
                console.error('Could not copy text: ', err);
                alert('Failed to copy text. Please select and copy manually.');
            });
        });
    </script>
</body>
</html> 